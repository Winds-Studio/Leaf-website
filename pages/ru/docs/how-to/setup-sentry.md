# Как настроить Sentry с Leaf

[Sentry](https://sentry.io/) является мощным сервисом для отслеживания ошибок в реальном времени и мониторинга производительности. Интеграция с вашим сервером Leaf позволяет автоматически фиксировать ошибки и исключения, что значительно упрощает диагностику и устранение проблем, возникающих на сервере.

Это руководство объясняет, как настроить Leaf для отправки отчётов об ошибках в ваш проект Sentry.

## Предварительные требования

1.  **Учётная запись Sentry:** Вам нужна учётная запись на [sentry.io](https://sentry.io/). Они предлагают бесплатные тарифы, подходящие для многих серверов.
2.  **Проект Sentry:** Создайте новый проект в рамках вашей организации Sentry.
    *   Когда будет предложено выбрать платформу, выберите **Java**. Если Java сразу не отображается, вы можете выбрать "Other" (Другое) или найти её через поиск. Конкретный выбор платформы в значительно влияет на начальную настройку.
3.  **DSN (Data Source Name):** После создания проекта перейдите в его настройки. Найдите раздел "Client Keys (DSN)". Скопируйте строку DSN – она выглядит как URL (например, ... `https://xxxxxxxxxxxxxxxxxxxxxxxx@o######.ingest.sentry.io/#######`).

## Шаги настройки

1.  **Найдите конфигурационный файл Leaf:** Откройте основной файл конфигурации сервера Leaf. Обычно это `leaf-global.yml` который находится в корневой директории сервера или в подпапке `config`.

2.  **Найдите раздел Sentry:** Внутри конфигурационного файла найдите раздел `sentry:` по умолчанию он будет выглядеть примерно так:

    ```yaml
    sentry:
      # Sentry DSN for improved error logging, leave blank to disable,
      # Obtain from https://sentry.io/
      dsn: ''
      # Logs with a level higher than or equal to this level will be recorded.
      log-level: WARN
      # Only log with a Throwable will be recorded after enabling this.
      only-log-thrown: true
    ```

3.  **Настройка параметров:**

    *   **`dsn`:**
        *   Замените пустые одинарные кавычки (`''`) на DSN, который вы скопировали из настроек проекта Sentry. Убедитесь, что он заключён в одинарные кавычки.
        *   **Example:** `dsn: 'https://xxxxxxxxxxxxxxxxxxxxxxxx@o######.ingest.sentry.io/#######'`
        *   *Если оставить это поле пустым, интеграция с Sentry будет отключена.*

    *   **`log-level`:**
        *   Это определяет минимальный уровень строгости логов, которые Leaf будет отправлять в Sentry. К распространённым уровням относятся  `ERROR`, `WARN`, `INFO`, `DEBUG`.
        *   Значение по умолчанию `WARN` означает, что будут отправляться только сообщения, зарегистрированные как предупреждения или ошибки (которые обычно включают исключения).
        *   Вы можете установить значение `ERROR`, если хотите получать только критические ошибки. Установка на более низкий уровень (например, `INFO`) может привести к отправке значительно большего объёма данных и может быть нежелательной, если вы не занимаетесь активной отладкой.
        *   **Рекомендация:** Начните с `WARN` (значение по умолчанию).

    *   **`only-log-thrown`:**
        *   Если установлено значение `true` (по умолчанию), Leaf будет *только* отправлять сообщения в Sentry, если они явно содержат Java `Throwable` (например, исключение или ошибку с трассировкой стека). Это настоятельно рекомендуется, так как позволяет Sentry сосредоточиться на реальных ошибках в коде.
        *   Если установлено значение `false`, *любой* лог, соответствующий уровню `log-level` будет отправляться, даже если это просто информационное сообщение без ошибки. Это может создать много шума в Sentry.
        *   **Рекомендация:** Оставьте это значение `true` (по умолчанию).

4.  **Сохраните и перезапустите:**
    *   Сохраните изменения в файле конфигурации.
    *   Полностью перезапустите сервер Leaf, чтобы новые настройки вступили в силу.

## Устранение неполадок

*   **Ошибки не отображаются:**
    *   Убедитесь, что `dsn` скопирован правильно и заключён в одинарные кавычки в YAML-файле.
    *   Убедитесь, что `log-level` не установлен слишком высоко (например, если стоит `ERROR`, предупреждения отправляться не будут).
    *   Убедитесь, `only-log-thrown` соответствует типу ошибок, которые вы ожидаете увидеть.
    *   Убедитесь, что сервер был полностью перезапущен после изменения конфигурации.
    *   Проверьте, не блокирует ли брандмауэр вашего сервера исходящие подключения к `ingest.sentry.io` на порту 443 (HTTPS).
*   **Слишком много ошибок:**
    *   Повысите значение `log-level` (например, с `WARN` до `ERROR`).
    *   Убедитесь `only-log-thrown` имеет значение `true`.